<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Earing Technology</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --primary-color: #007bff; --primary-hover: #0056b3; --secondary-color: #343a40;
            --background-color: #f0f2f5; --text-color: #212529; --text-muted-color: #6c757d;
            --accent-color: #28a745; --card-bg: #ffffff; --shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .container {
            width: 100%; height: 100%; max-width: 420px; background: var(--background-color);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        header {
            background: var(--card-bg); padding: 10px 15px; display: flex; align-items: center;
            justify-content: space-between; border-bottom: 1px solid #dee2e6;
        }
        .user-profile { display: flex; align-items: center; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #e9ecef; }
        .user-info .username { font-size: 16px; font-weight: 600; margin: 0; }
        .wallet-display {
            display: flex; align-items: center; background: #e9ecef; padding: 5px 10px; border-radius: 20px;
        }
        .wallet-display .icon { font-size: 16px; color: var(--primary-color); margin-right: 8px; }
        .wallet-display .points { font-size: 14px; font-weight: 600; }
        main { flex-grow: 1; overflow-y: auto; padding: 20px 15px 80px 15px; }
        .view { display: none; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; }
        .task-card {
            background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; cursor: pointer; transition: all 0.2s ease; box-shadow: var(--shadow);
        }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .task-icon { font-size: 20px; color: var(--primary-color); margin-right: 15px; width: 25px; text-align: center; }
        .task-details h3 { margin: 0; font-size: 15px; font-weight: 600; }
        .task-details p { margin: 2px 0 0; font-size: 12px; color: var(--text-muted-color); }
        .footer-nav {
            position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 420px; margin: 0 auto;
            display: flex; justify-content: space-around; background: var(--card-bg);
            padding: 8px 0; border-top: 1px solid #dee2e6; box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        .nav-button {
            display: flex; flex-direction: column; align-items: center; color: var(--text-muted-color);
            background: none; border: none; font-size: 11px; transition: color 0.2s ease; cursor: pointer; flex-grow: 1;
        }
        .nav-button .icon { font-size: 20px; margin-bottom: 4px; }
        .nav-button.active { color: var(--primary-color); }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
        .form-group input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ced4da;
            font-size: 16px; background-color: #f8f9fa;
        }
        .action-button {
            width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;
            font-weight: 600; margin-top: 10px; cursor: pointer; transition: background-color 0.2s ease;
            background-color: var(--primary-color); color: white;
        }
        .action-button:disabled { background-color: #a9a9a9; cursor: not-allowed; }
        .payment-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .payment-method-card {
            background: var(--card-bg); border-radius: 12px; padding: 20px 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--shadow); transition: all 0.2s ease;
        }
        .payment-method-card:hover { transform: translateY(-3px); }
        .payment-method-card img { height: 40px; margin-bottom: 10px; }
        .payment-method-card span { font-weight: 600; }
        .referral-box {
            background: var(--card-bg); padding: 20px; text-align: center; border-radius: 12px; box-shadow: var(--shadow);
        }
        .referral-link-container {
            display: flex; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; margin-top: 15px;
        }
        .referral-link-container input {
            flex-grow: 1; border: none; padding: 10px; font-size: 14px; background: #f1f1f1;
        }
        .referral-link-container button {
            background: var(--primary-color); color: white; border: none; padding: 0 15px; cursor: pointer;
        }
        .loader { text-align: center; padding: 50px; }
        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 340px;
        }
    </style>
</head>
<body>
    <div class="container" id="app-container" style="display: none;">
        <header>
            <div class="user-profile">
                <img id="user-avatar" class="user-avatar" src="" alt="A">
                <div class="user-info">
                    <h2 id="username" class="username">User</h2>
                </div>
            </div>
            <div class="wallet-display">
                <i class="fas fa-wallet icon"></i>
                <span id="points-value" class="points">0</span>
            </div>
        </header>

        <main id="main-content">
            <!-- Home/Tasks View -->
            <div id="home-view" class="view active">
                <h2 class="section-title">Earning Tasks</h2>
                <div id="task-list">
                    <!-- Tasks will be loaded here from Firebase -->
                </div>
            </div>

            <!-- Wallet View -->
            <div id="wallet-view" class="view">
                <h2 class="section-title">My Wallet</h2>
                <div class="referral-box" style="margin-bottom: 20px;">
                    <h3>Total Coins: <span id="wallet-points-total">0</span></h3>
                    <button id="withdraw-btn" class="action-button">Withdraw Now</button>
                </div>
                <div id="payment-methods-container" style="display: none;">
                    <h2 class="section-title">Select Payment Method</h2>
                    <div id="payment-methods-list" class="payment-methods">
                        <!-- Payment methods will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Refer View -->
            <div id="refer-view" class="view">
                <h2 class="section-title">Refer & Earn</h2>
                <div class="referral-box">
                    <h3>Invite Friends, Earn Coins!</h3>
                    <p>Earn <span id="refer-bonus-amount">500</span> coins for every friend who joins.</p>
                    <div class="referral-link-container">
                        <input type="text" id="referral-link" readonly>
                        <button onclick="copyReferralLink()"><i class="fas fa-copy"></i></button>
                    </div>
                    <h3 style="margin-top: 20px;">Total Referrals: <span id="total-referrals">0</span></h3>
                </div>
            </div>
        </main>

        <nav class="footer-nav">
            <button class="nav-button active" onclick="showView('home-view')"><i class="icon fas fa-home"></i>Home</button>
            <button class="nav-button" onclick="showView('wallet-view')"><i class="icon fas fa-wallet"></i>Wallet</button>
            <button class="nav-button" onclick="showView('refer-view')"><i class="icon fas fa-user-friends"></i>Refer</button>
        </nav>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <h3 id="withdraw-method-title">Withdraw</h3>
            <form id="withdraw-form">
                <div class="form-group">
                    <label for="account-number">Account Number</label>
                    <input type="text" id="account-number" placeholder="e.g., 01700000000" required>
                </div>
                <div class="form-group">
                    <label for="account-name">Your Name</label>
                    <input type="text" id="account-name" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="amount">Amount (Coins)</label>
                    <input type="number" id="amount" placeholder="Min 10000" required>
                </div>
                <button type="submit" class="action-button">Send Request</button>
                <button type="button" class="action-button" style="background-color: var(--text-muted-color); margin-top: 10px;" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>
    
    <div id="loader" class="loader">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p>Loading Earing Technology...</p>
    </div>

    <!-- Monetag SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9574416' data-sdk='show_9574416'></script>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfQBxUY9ftvzXTJykMf4Z_mEvIgaQ0RyI",
            authDomain: "earing-technology.firebaseapp.com",
            databaseURL: "https://earing-technology-default-rtdb.firebaseio.com",
            projectId: "earing-technology",
            storageBucket: "earing-technology.firebasestorage.app",
            messagingSenderId: "567390086459",
            appId: "1:567390086459:web:a717e290a37a623be9431e",
            measurementId: "G-C8CK3P3LQL"
        };

        // --- App State ---
        let tgUser = null;
        let appConfig = {
            pointsPerAd: 10,
            minWithdraw: 10000,
            referralBonus: 500,
            botUsername: "Earingtechnology99_bot"
        };
        let userProfile = {
            points: 0,
            referrals: 0,
            referredBy: null
        };
        let selectedPaymentMethod = null;

        // --- Initialize App ---
        document.addEventListener('DOMContentLoaded', () => {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            tgUser = Telegram.WebApp.initDataUnsafe.user;
            // For testing in browser
            // tgUser = { id: 12345, first_name: 'Test', username: 'testuser', photo_url: '' };

            if (!tgUser) {
                document.getElementById('loader').innerHTML = '<p>Could not verify user. Please open this app via Telegram.</p>';
                return;
            }

            firebase.initializeApp(firebaseConfig);
            loadInitialData();
        });

        async function loadInitialData() {
            const db = firebase.database();
            
            // 1. Fetch App Config
            const configRef = db.ref('config');
            configRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    appConfig.pointsPerAd = data.pointsPerAd || 10;
                    appConfig.minWithdraw = data.minWithdraw || 10000;
                    appConfig.referralBonus = data.referralBonus || 500;
                    appConfig.botUsername = data.botUsername || "Earingtechnology99_bot";
                }
                updateUIConfig();
            });

            // 2. Fetch Tasks
            const tasksRef = db.ref('tasks');
            tasksRef.on('value', (snapshot) => {
                const tasks = snapshot.val();
                renderTasks(tasks);
            });

            // 3. Fetch Payment Methods
            const paymentMethodsRef = db.ref('paymentMethods');
            paymentMethodsRef.on('value', (snapshot) => {
                const methods = snapshot.val();
                renderPaymentMethods(methods);
            });
            
            // 4. Fetch or Create User Profile
            const userRef = db.ref('users/' + tgUser.id);
            userRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    userProfile = snapshot.val();
                } else {
                    // New user, potentially with a referral
                    const startParam = new URLSearchParams(window.location.hash.substring(1)).get('start');
                    userProfile.referredBy = startParam || null;
                    userRef.set(userProfile);
                    
                    if(userProfile.referredBy) {
                        creditReferrer(userProfile.referredBy);
                    }
                }
                updateUserDisplay();
                document.getElementById('loader').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
            });
        }
        
        function creditReferrer(referrerId) {
            if (!referrerId) return;
            const referrerRef = firebase.database().ref(`users/${referrerId}`);
            referrerRef.transaction((referrerData) => {
                if (referrerData) {
                    referrerData.points = (referrerData.points || 0) + appConfig.referralBonus;
                    referrerData.referrals = (referrerData.referrals || 0) + 1;
                }
                return referrerData;
            });
        }

        // --- UI Rendering ---
        function updateUIConfig() {
            document.getElementById('refer-bonus-amount').innerText = appConfig.referralBonus;
            document.getElementById('referral-link').value = `https://t.me/${appConfig.botUsername}?start=${tgUser.id}`;
        }
        
        function updateUserDisplay() {
            document.getElementById('username').innerText = tgUser.first_name || tgUser.username || 'User';
            if(tgUser.photo_url) {
                document.getElementById('user-avatar').src = tgUser.photo_url;
            }
            document.getElementById('points-value').innerText = userProfile.points || 0;
            document.getElementById('wallet-points-total').innerText = userProfile.points || 0;
            document.getElementById('total-referrals').innerText = userProfile.referrals || 0;

            const withdrawBtn = document.getElementById('withdraw-btn');
            withdrawBtn.disabled = (userProfile.points || 0) < appConfig.minWithdraw;
        }
        
        function renderTasks(tasks) {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            if (!tasks) {
                list.innerHTML = '<p>No tasks available right now.</p>';
                return;
            }
            for (const key in tasks) {
                const task = tasks[key];
                const card = document.createElement('div');
                card.className = 'task-card';
                card.onclick = () => handleTaskClick(task.type);
                card.innerHTML = `
                    <div class="task-icon"><i class="fas fa-play-circle"></i></div>
                    <div class="task-details">
                        <h3>${task.title}</h3>
                        <p>${task.description}</p>
                    </div>
                `;
                list.appendChild(card);
            }
        }
        
        function renderPaymentMethods(methods) {
            const container = document.getElementById('payment-methods-list');
            container.innerHTML = '';
            if (!methods) return;
            for (const key in methods) {
                const method = methods[key];
                const card = document.createElement('div');
                card.className = 'payment-method-card';
                card.onclick = () => showWithdrawModal(method);
                card.innerHTML = `
                    <img src="${method.imageUrl}" alt="${method.name}">
                    <span>${method.name}</span>
                `;
                container.appendChild(card);
            }
        }

        // --- View & Modal Management ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.nav-button[onclick="showView('${viewId}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function showWithdrawModal(method) {
            selectedPaymentMethod = method;
            document.getElementById('withdraw-method-title').innerText = `Withdraw via ${method.name}`;
            document.getElementById('withdraw-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('withdraw-modal').classList.remove('active');
            document.getElementById('withdraw-form').reset();
        }

        // --- Core Logic ---
        function handleTaskClick(type) {
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
            
            const adFunction = () => {
                if (type === 'rewarded_interstitial') {
                    return show_9574416();
                } else if (type === 'rewarded_popup') {
                    return show_9574416('pop');
                } else if (type === 'in_app_interstitial') {
                    show_9574416({ type: 'inApp', inAppSettings: { frequency: 2, capping: 0.1, interval: 30, timeout: 5, everyPage: false }});
                    // In-app doesn't have a promise, so we reward immediately
                    return Promise.resolve();
                }
                return Promise.reject('Unknown ad type');
            };

            adFunction().then(grantReward).catch(err => {
                console.error('Ad Error:', err);
                // In-app interstitial reward is handled differently, so we check for its specific type
                if(type === 'in_app_interstitial') {
                     grantReward();
                } else {
                    Telegram.WebApp.showAlert('Ad could not be shown. Please try again later.');
                }
            });
        }

        function grantReward() {
            const newPoints = (userProfile.points || 0) + appConfig.pointsPerAd;
            firebase.database().ref('users/' + tgUser.id + '/points').set(newPoints)
            .then(() => {
                Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                Telegram.WebApp.showAlert(`Congratulations! You've earned ${appConfig.pointsPerAd} coins.`);
            });
        }
        
        document.getElementById('withdraw-btn').addEventListener('click', () => {
            const container = document.getElementById('payment-methods-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('withdraw-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const accountNumber = document.getElementById('account-number').value;
            const accountName = document.getElementById('account-name').value;
            const amount = parseInt(document.getElementById('amount').value);

            if (amount < appConfig.minWithdraw || amount > userProfile.points) {
                Telegram.WebApp.showAlert(`Invalid amount. Please enter a value between ${appConfig.minWithdraw} and ${userProfile.points}.`);
                return;
            }

            const requestData = {
                userId: tgUser.id,
                username: tgUser.username || tgUser.first_name,
                paymentMethod: selectedPaymentMethod.name,
                accountNumber,
                accountName,
                amount,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            const newRequestRef = firebase.database().ref('withdrawal_requests').push();
            newRequestRef.set(requestData).then(() => {
                // Deduct points from user
                const newPoints = userProfile.points - amount;
                firebase.database().ref('users/' + tgUser.id + '/points').set(newPoints);

                Telegram.WebApp.showAlert('Your request is pending. Please wait up to 72 hours.');
                closeModal();
            }).catch(err => {
                Telegram.WebApp.showAlert('Failed to submit request. Please try again.');
            });
        });

        function copyReferralLink() {
            const linkInput = document.getElementById('referral-link');
            linkInput.select();
            document.execCommand('copy');
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            Telegram.WebApp.showAlert('Referral link copied!');
        }
    </script>
</body>
</html>
